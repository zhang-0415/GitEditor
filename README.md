准备数据
下载数据集
本案例使用的口罩识别数据集包含500张图片，均已标注已经发布在AI市场，我们从华为云AI市场订阅数据集至ModelArts，然后就可以在ModelArts中使用了。点击此链接进入下载详情页，下载详情页示例如下：

dataset_download

下载方式：选择ModelArts数据集

目标区域：华北-北京四

目标位置：选择一个OBS路径，作为数据集的存储位置。

名称：自定义

填写好参数后，点击food按钮，然后点击food按钮。等待数据集状态变为推送成功，即可在ModelArts数据集列表中查看到下载的数据集。

等待数据集发布成功。

注意：该口罩识别数据集只能用于学习用途，不得用于商业用途。

发布数据集
点击进入ModelArts数据集列表，找到刚订阅的数据集，点击“发布”按钮，填写训练集比例为0.8，发布数据集。数据集发布之后，才可在训练中使用。

mask

create_dataset

数据标注格式解读
数据集发布成功后，点击进入数据集，然后点击“开始标注”按钮，观察数据标注详情。其中一张样例图片的标注详情如下：

mask

数据集共有三种类型的标注框，person（包含头部和肩部）、face和mask。判断一个人有没有戴口罩的方法是，脸部的检测框里面是否有口罩的检测框。person物体的作用是对人做目标跟踪。

订阅算法
本实验中，我们从AI市场订阅ModelArts官方发布的物体检测算法FasterRCNN来训练模型。

点击进入AI市场YOLOv3_ResNet18算法主页，点击页面右上方的food按钮。然后点击页面下方的food按钮，再点击food按钮，最后点击food按钮进入我的订阅页面，可以看到刚刚订阅的算法。点击food超链接，进入算法管理页面。

点击“同步”按钮，同步算法，可以点击food按钮，刷新状态。当状态变成就绪时，表示同步成功。

模型训练
我们在ModelArts中训练模型，并将模型格式转换成可在HiLens Kit上运行的格式。

创建训练作业
接下来将通过ModelArts训练作业训练AI模型，使用ModelArts的yolov3预置算法训练一个口罩检测模型。

进入ModelArts管理控制台，进入ModelArts“训练作业”页面。

单击“创建”按钮，进入“创建训练作业”页面。

在“创建训练作业”页面，按照如下指导填写训练作业相关参数。

“计费模式”和“版本”为系统自动生成，不需修改。

名称：自定义

描述：描述信息，可选。

trainjob_test

算法来源：算法管理

算法名称：物体检测-YOLOv3_ResNet18

训练输入：数据集

选择数据集和版本：选择刚刚发布的口罩数据集及其版本

训练输出：选择一个空的OBS路径，用来存储训练输出的模型。如/modelarts-course/mask_detection_500/output/，该路径需要自己创建。

trainjob-parameter.png

调优参数：保持默认。我们训练200个epochs，学习率设置为0.001，epochs值越大训练时间越长。

作业日志路径：选择一个空的OBS路径，用来存储作业训练日志。如/modelarts-course/mask_detection_500/log/，该路径需要自己创建。

trainjob-parameter.png

资源池：公共资源池

规格：CPU：8 核 64GiB GPU：1 * nvidia-p100 16GiB。也可以选择V100，V100比P100的算力更强，但是更贵。

计算节点：1

trainjob-source.png

完成信息填写，单击“下一步”。

在“规格确认”页面，确认填写信息无误后，单击“立即创建”。

在“训练作业”管理页面，可以查看新建训练作业的状态。

如果设置max_epochs=200，训练过程需要20分钟左右。当状态变更为“运行成功”时，表示训练作业运行完成。 您可以单击训练作业的名称，可进入此作业详情页面，了解训练作业的“配置信息”、“日志”、“资源占用情况”和“评估结果”等信息。

模型转换
进入ModelArts管理控制台，在左侧导航栏中选择“ 模型管理”> “压缩/转换”，进入模型转换列表页面。

单击左上角的“创建任务”，进入任务创建任务页面。

在“创建任务”页面，填写相关信息。

名称：输入“convert-mask-detection”。

描述：口罩识别。

输入框架：TensorFlow

转换输入目录：训练作业的训练输出目录下的frozen_graph OBS目录，本案例中是/modelarts-course/mask_detection_500/output/frozen_graph/。

输出框架：MindSpore

转换输出目录：训练作业的训练输出目录下的om/model OBS目录，本案例中是/modelarts-course/mask_detection_500/output/om/model/。

转换模板：选择“TensorFlow frozen graph 转 Ascend”。即将TensorFlow的frozen graph格式的模型转换成可在昇腾芯片上推理的格式。

输入张量形状：images:1,352,640,3。 convert_model

任务信息填写完成后，单击右下角“立即创建”按钮。等待模型转换任务完成。

新建技能
导入模型
登录Huawei HiLens管理控制台，在左侧导航栏中选择 “技能开发” > “模型管理”，进入“模型管理”页面。
在“模型管理”页面，单击右上角的 “导入（转换）模型”。
在“导入模型”页面，然后参考图3-1填写参数，信息确认无误后单击 **“确定”**完成导入。
名称：输入 “mask-detection”。

版本：输入 “1.0.0”。

描述：一段简短的描述。口罩识别模型，用于检测人是否佩戴口罩。

模型来源：单击 “从ModelArts导入”，在右侧下拉框中选择 “OM（从转换任务中获取）”，然后在下方转换任务列表中勾选之前ModelArts中的模型转换任务 “convert-mask-detection”。 importmodel

模型导入后，将进入 “模型管理” 页面，您导入的模型可从列表中查看。

开始新建技能
在Huawei HiLens管理控制台的左侧导航栏中选择 “技能开发” > “技能管理”，进入技能列表。
在“技能管理”页面，单击右上角 “新建技能”，进入“创建技能”页面。
填写基本信息 在“创建技能”页面，在“技能模板”中选择“使用空模板”后，填写基本信息:
技能模板：选择 “使用空模板”。

名称（英文）：输入 “Mask_Detection”。

名称（中文）：输入 “口罩识别”。

版本：输入 “1.0.0”。

适用芯片：默认为 “Ascend310”。

检验值：输入 “mask”。

应用场景：选择 “其他”，文本框中输入 “口罩识别”。

技能图标：上传技能图片。可选。

技能图片：用来向用户介绍技能的使用或技能的效果，可不上传。

OS平台：选择 “ Linux”系统。

英文描述：输入技能的英文描述。

描述：输入技能的中文描述。 Create_skills

Create_skills
4. 填写技能内容 根据您的模型和逻辑代码情况，填写技能内容，详细参数说明如下：

模型：单击加号，您可以在弹出框中，选择导入的模型mask-detection。

运行时语言：选择Python3.7。

代码执行文件：输入index.py。

代码上传方式：选择“在线编辑”，在代码编辑框中直接编辑代码。一共有两个代码源文件，index.py和 utils.py，将这两个文件中的代码依次复制到对应的代码编辑框中。utils.py文件可以通过代码编辑框左上角的“文件” > “创建同级文件”来创建，见下图。

注意：请确保index.py红线框中的模型名称和模型转换任务名称保持一致，否则请修改红线框中的模型名称。

mian.py

确认信息并完成新建技能
上述参数填写完成后，您可以在界面右侧查看其配置参数值，如果某个字段填写错误，在右侧会显示一个小红叉。 确认信息无误后，单击“确定”完成技能创建。
技能代码解读
查看utils.py文件的代码，可以看出该口罩识别技能的实现逻辑。针对每个人，它会尝试检测出person、face和mask三个检测框。如果mask检测框位于face检测框的重合度大于一个阈值，就判断已佩戴口罩；如果mask检测框位于face检测框的重合度小于这个阈值或者没有检测到mask检测框，就判断没有佩戴口罩；当即没有检测到face，也没有检测到mask，就会显示Unknown，表示未知。
